<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eco-Mind Analytics</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        [x-cloak] { display: none !important; }
        /* Smooth scrolling for the whole page */
        html { scroll-behavior: smooth; }
        
        /* Hide scrollbar for clean UI but keep functionality */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* Custom scrollbar for the sidebar */
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: #1f2937; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 3px; }

        .legend-footer {
            width: 100%;
            background-color: #1a1a1a;
            color: white;
            padding: 10px 20px;
            border-top: 2px solid #333;
            margin-top: auto; /* Pushes to bottom if inside flex container */
        }

        .legend-container {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
        }

        .legend-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            background: #c0bcbcff;
            padding: 5px;
            border: 1px solid #333;
            border-radius: 4px;
        }

        .legend-item span {
            font-size: 10px;
            color: #232222ff;
            margin-bottom: 3px;
            font-family: monospace;
        }

        .legend-item img {
            height: 35px; /* Fixed height for clean alignment */
            width: auto;
            display: block;
        }
        /* HEADER STYLES */
        body {
            margin: 0; /* Remove default margin so header touches edges */
            padding-top: 60px; /* Push content down so header doesn't overlap it */
        }

        .top-nav {
            position: fixed; /* Sticks to the top */
            top: 0;
            left: 0;
            width: 100%;
            height: 60px;
            background-color: #000000; /* Slightly darker than page bg for contrast */
            border-bottom: 1px solid #333;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 30px;
            z-index: 1000; /* Ensures it stays on top of maps/panels */
            box-shadow: 0 2px 10px rgba(0,0,0,0.5);
        }

        .nav-brand {
            font-size: 18px;
            font-weight: bold;
            color: #fff;
            letter-spacing: 1px;
        }

        .nav-links {
            display: flex;
            gap: 20px;
        }

        .nav-item {
            text-decoration: none;
            color: #888;
            font-size: 14px;
            padding: 8px 16px;
            border-radius: 4px;
            transition: all 0.2s ease;
            font-weight: 500;
        }

        .nav-item:hover {
            color: #fff;
            background-color: #222;
        }

        /* Style for the currently selected page */
        .nav-item.active {
            color: #fff;
            background-color: #333; /* Or your brand color like #008000 (Green) */
            border: 1px solid #444;
        }
    </style>
</head>
<body class="bg-gray-950 text-white font-sans h-screen flex overflow-hidden" 
      x-data="appData()" x-init="init()">
    <header class="top-nav">
        <div class="nav-brand"><h1 class="text-xl font-bold text-white tracking-widest">ECO<span class="text-green-500">MIND</span></h1></div> <nav class="nav-links">
            <a href="/" class="nav-item active">Geospatial Data</a>
            <a href="/psychometric" class="nav-item">Psychometric Data</a>
            <a href="/insights" class="nav-item">Insights</a>
            <a href="/leaderboard" class="nav-item">Leaderboard</a>
            <a href="/prod_pitch" class="nav-item">Product Pitch</a>
        </nav>
    </header>

    <aside class="w-64 bg-gray-900 border-r border-gray-800 flex flex-col z-30 flex-shrink-0">
        <div class="p-6 bg-gray-900 border-b border-gray-800">
            
            <p class="text-[10px] text-gray-500 mt-1">Select up to 5 campuses</p>
        </div>
        
        <div class="p-3">
            <input type="text" x-model="search" placeholder="Search..." 
                   class="w-full bg-gray-800 border border-gray-700 rounded px-3 py-2 text-xs focus:border-green-500 outline-none text-gray-300">
        </div>

        <div class="flex-1 overflow-y-auto custom-scroll px-2 space-y-1 pb-4">
            <template x-for="college in filteredColleges" :key="college.short_name">
                <div @click="toggleCollege(college)" 
                     class="cursor-pointer px-3 py-3 rounded-lg flex items-center justify-between transition-all duration-200 group border"
                     :class="isSelected(college) ? 'bg-gray-800 border-gray-600' : 'hover:bg-gray-800 border-transparent'">
                    
                    <div>
                        <div class="font-bold text-sm text-gray-300" 
                             :class="isSelected(college) ? getColorText(getCollegeIndex(college)) : ''"
                             x-text="college.name"></div>
                        <div class="text-[10px] text-gray-500" x-text="college.short_name"></div>
                    </div>
                    
                    <div class="w-3 h-3 rounded-full"
                         :class="isSelected(college) ? getBgColor(getCollegeIndex(college)) : 'bg-gray-700'">
                    </div>
                </div>
            </template>
        </div>
    </aside>

    <main class="flex-1 flex flex-col h-full overflow-hidden">
        
        <div class="h-[45%] bg-gray-900 border-b-4 border-gray-800 flex flex-col flex-shrink-0">
            
            <div class="px-6 py-3 bg-gray-900 border-b border-gray-800 flex justify-between items-center shadow-md z-20">
                <div class="flex gap-4 overflow-x-auto no-scrollbar">
                    <template x-for="metric in availableMetrics" :key="metric">
                        <button @click="toggleMetric(metric)" 
                                class="px-3 py-1 rounded-full text-[10px] font-bold border transition-all whitespace-nowrap"
                                :class="activeMetrics.includes(metric) ? 'bg-pink-100 text-black border-pink' : 'bg-gray-800 text-gray-400 border-gray-700 hover:border-gray-500'">
                            <span x-text="formatMetricName(metric)"></span>
                        </button>
                    </template>
                </div>
                
                <div class="flex gap-2 ml-4">
                     <template x-for="layer in availableLayers" :key="layer.id">
                        <button @click="toggleLayer(layer.id)" 
                                class="px-3 py-1 rounded-full text-[10px] font-bold border transition-all whitespace-nowrap"
                                :class="activeLayers.includes(layer.id) ? 'bg-yellow-100 text-black border-yellow' : 'bg-gray-800 text-black-400 border-gray-700 hover:border-gray-500'"
                                :title="layer.name">
                            <span x-text="layer.name"></span>
                        </button>
                    </template>
                </div>
            </div>

            <div class="flex-1 p-4 overflow-y-auto custom-scroll bg-gray-950">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="charts-container">
                    </div>
                
                <div x-show="selectedColleges.length === 0" class="h-full flex items-center justify-center text-gray-600">
                    <p>Select colleges to generate comparison graphs</p>
                </div>
            </div>
        </div>

        <div class="flex-1 overflow-y-auto custom-scroll bg-black p-6">
            
            <div class="flex gap-6 min-w-max mx-auto" :class="selectedColleges.length < 3 ? 'justify-center' : ''">
                
                <template x-for="(college, index) in selectedColleges" :key="college.short_name">
                    
                    <div class="w-80 flex flex-col gap-4 animate-fade-in-up">
                        
                        <div class="p-4 rounded-xl border-t-4 bg-gray-900 shadow-xl"
                             :class="getBorderColor(index)">
                            <div class="flex justify-between items-start mb-2">
                                <h2 class="text-lg font-bold text-white leading-tight" x-text="college.name"></h2>
                                <button @click="toggleCollege(college)" class="text-gray-500 hover:text-white">✕</button>
                            </div>
                            <div class="flex items-center text-xs text-gray-400 mb-3">
                                <svg class="w-3 h-3 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                                <span x-text="college.lat.toFixed(4) + ', ' + college.lng.toFixed(4)"></span>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-3">
                                <div class="bg-gray-800 p-2 rounded-lg text-center">
                                    <div class="text-[10px] text-gray-500 uppercase font-bold">Green Score</div>
                                    <div class="text-2xl font-black text-green-400" x-text="Math.round(college.Green_Score) || 0"></div>
                                </div>
                                <div class="bg-gray-800 p-2 rounded-lg text-center">
                                    <div class="text-[10px] text-gray-500 uppercase font-bold">Mind Score</div>
                                    <div class="text-2xl font-black text-purple-400" x-text="Math.round(college.Mind_Score) || 0"></div>
                                </div>
                            </div>
                        </div>

                        <div class="bg-gray-900 rounded-xl p-4 border border-gray-800">
                            <h3 class="text-xs font-bold text-gray-500 uppercase mb-3">Key Metrics</h3>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between border-b border-gray-800 pb-1">
                                    <span class="text-gray-400">Vegetation (NDVI)</span>
                                    <span class="font-mono text-white" x-text="college.NDVI_mean?.toFixed(3)"></span>
                                </div>
                                <div class="flex justify-between border-b border-gray-800 pb-1">
                                    <span class="text-gray-400">Built-Up (NDBI)</span>
                                    <span class="font-mono text-white" x-text="college.NDBI_mean?.toFixed(3)"></span>
                                </div>
                                <div class="flex justify-between border-b border-gray-800 pb-1">
                                    <span class="text-gray-400">Surface Temp</span>
                                    <span class="font-mono text-white" x-text="college.LST_mean?.toFixed(1) + '°C'"></span>
                                </div>
                                <div class="flex justify-between border-b border-gray-800 pb-1">
                                    <span class="text-gray-400">Student Stress</span>
                                    <span class="font-mono text-white" x-text="college.Avg_Stress?.toFixed(1) + '/10'"></span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-400">Air Quality</span>
                                    <span class="font-mono text-white" x-text="college['pm25(microg/10m3)']?.toFixed(1)"></span>
                                </div>
                            </div>
                        </div>

                        <div class="flex flex-col gap-3">
                             <template x-for="layerId in activeLayers" :key="layerId">
                                <div class="rounded-xl overflow-hidden bg-black border border-gray-800 relative group shadow-lg">
                                    <div class="absolute top-2 left-2 bg-black/70 backdrop-blur px-2 py-1 rounded text-[10px] text-white z-10 font-bold uppercase tracking-wider border border-white/10">
                                        <span x-text="getLayerName(layerId)"></span>
                                    </div>
                                    <img :src="'/api/image/' + college.short_name + '/' + layerId" 
                                         loading="lazy"
                                         class="w-full h-auto object-contain opacity-90 group-hover:opacity-100 transition-opacity duration-300"
                                         style="min-height: 200px;"
                                         alt="Layer">
                                </div>
                            </template>
                        </div>

                    </div>
                </template>
            </div>
            <div class="legend-footer" 
            x-data="{ 
                legends: [
                    {id: 'lulcout', name: 'LULC Class'}, 
                    {id: 'ndvi', name: 'NDVI (Vegetation)'}, 
                    {id: 'ndbi', name: 'NDBI (Urban)'}, 
                    {id: 'lst',  name: 'LST (Temp)'}, 
                    {id: 'aot',  name: 'Air Quality'}, 
                    {id: 'shade', name: 'Shade'}
                ]
            }">
            
            <h3>Layer Legends</h3>
            
            <div class="legend-container">
                <template x-for="item in legends" :key="item.id">
                    <div class="legend-item">
                        <span x-text="item.name"></span>
                        
                        <img :src="'/get_legend/' + item.id" :alt="item.name">
                    </div>
                </template>
            </div>
        </div>
        </div>

        

    </main>

    <script>
        // --- CONFIGURATION ---
        const COLLEGE_PALETTE = [
            { bg: 'bg-teal-500', text: 'text-teal-500', border: 'border-teal-500', hex: '#14B8A6' },  // Col 1
            { bg: 'bg-indigo-500', text: 'text-indigo-500', border: 'border-indigo-500', hex: '#6366F1' }, // Col 2
            { bg: 'bg-rose-500', text: 'text-rose-500', border: 'border-rose-500', hex: '#F43F5E' },     // Col 3
            { bg: 'bg-amber-500', text: 'text-amber-500', border: 'border-amber-500', hex: '#F59E0B' },   // Col 4
            { bg: 'bg-emerald-500', text: 'text-emerald-500', border: 'border-emerald-500', hex: '#10B981' } // Col 5
        ];

        const METRIC_LABELS = {
            'Green_Score': 'Green Score', 'Mind_Score': 'Mind Score',
            'NDVI_mean': 'NDVI', 'NDBI_mean': 'NDBI', 'LST_mean': 'Temp (LST)',
            'Avg_Stress': 'Stress', 'Avg_Mood': 'Mood', 'pm25(microg/10m3)': 'PM2.5'
        };

        function appData() {
            return {
                allColleges: [],
                search: '',
                selectedColleges: [],
                activeLayers: ['zoomout', 'ndvi'],
                activeMetrics: ['Green_Score', 'Mind_Score', 'LST_mean'], // Default graphs
                
                availableLayers: [
                    {id: 'zoomout', name: 'Satellite'}, {id: 'zoomin', name: 'Satellite Zoomed'},
                    {id: 'lulcout', name: 'LULC Mask'}, {id: 'ndvi', name: 'NDVI'}, {id: 'ndbi', name: 'NDBI'}, 
                    {id: 'lst', name: 'LST'}, {id: 'shade', name: 'Shade'}
                ],
                availableMetrics: [
                    'Green_Score', 'Mind_Score', 'NDVI_mean', 'NDBI_mean', 
                    'LST_mean', 'Avg_Stress', 'Avg_Mood', 'pm25(microg/10m3)'
                ],

                chartInstances: [],

                async init() {
                    fetch('/api/colleges')
                    .then(res => res.json())
                    .then(data => {
                        // Sort the data immediately upon receiving it
                        this.allColleges = data.sort((a, b) => a.name.localeCompare(b.name));
                    });
                },

                get filteredColleges() {
                    if (this.search === '') return this.allColleges;
                    return this.allColleges.filter(c => c.name.toLowerCase().includes(this.search.toLowerCase()));
                },

                // --- SELECTION LOGIC ---
                isSelected(college) {
                    return this.selectedColleges.some(c => c.short_name === college.short_name);
                },

                getCollegeIndex(college) {
                    return this.selectedColleges.findIndex(c => c.short_name === college.short_name);
                },

                toggleCollege(college) {
                    if (this.isSelected(college)) {
                        this.selectedColleges = this.selectedColleges.filter(c => c.short_name !== college.short_name);
                    } else {
                        if (this.selectedColleges.length >= 5) { alert("Max 5 colleges"); return; }
                        this.selectedColleges.push(college);
                    }
                    this.$nextTick(() => this.updateCharts());
                },

                toggleMetric(metric) {
                    this.activeMetrics.includes(metric) ? 
                        this.activeMetrics = this.activeMetrics.filter(m => m !== metric) : 
                        this.activeMetrics.push(metric);
                    this.$nextTick(() => this.updateCharts());
                },

                toggleLayer(id) {
                    this.activeLayers.includes(id) ? 
                        this.activeLayers = this.activeLayers.filter(l => l !== id) : 
                        this.activeLayers.push(id);
                },

                // --- STYLE HELPERS ---
                getBgColor(idx) { return COLLEGE_PALETTE[idx]?.bg || 'bg-gray-500'; },
                getColorText(idx) { return COLLEGE_PALETTE[idx]?.text || 'text-gray-500'; },
                getBorderColor(idx) { return COLLEGE_PALETTE[idx]?.border || 'border-gray-500'; },
                getLayerName(id) { return this.availableLayers.find(l => l.id === id)?.name || id; },
                formatMetricName(m) { return METRIC_LABELS[m] || m; },

                // --- CHART LOGIC ---
                updateCharts() {
                    const container = document.getElementById('charts-container');
                    container.innerHTML = ''; // Clear old charts
                    this.chartInstances.forEach(c => c.destroy());
                    this.chartInstances = [];

                    if (this.selectedColleges.length === 0) return;

                    // Generate a Chart for EACH active metric
                    this.activeMetrics.forEach(metric => {
                        // 1. Create Wrapper
                        const wrapper = document.createElement('div');
                        wrapper.className = "bg-gray-900 p-3 rounded-xl border border-gray-800 shadow-lg flex flex-col h-64";
                        
                        // 2. Create Title
                        const title = document.createElement('h4');
                        title.className = "text-xs font-bold text-gray-400 uppercase mb-2";
                        title.innerText = this.formatMetricName(metric);
                        wrapper.appendChild(title);

                        // 3. Create Canvas
                        const canvasContainer = document.createElement('div');
                        canvasContainer.className = "flex-1 relative";
                        const canvas = document.createElement('canvas');
                        canvasContainer.appendChild(canvas);
                        wrapper.appendChild(canvasContainer);
                        container.appendChild(wrapper);

                        // 4. Prepare Data
                        const labels = this.selectedColleges.map(c => c.short_name);
                        const data = this.selectedColleges.map(c => c[metric] || 0);
                        const bgColors = this.selectedColleges.map((c, i) => COLLEGE_PALETTE[i].hex);

                        // 5. Init ChartJS
                        const ctx = canvas.getContext('2d');
                        const newChart = new Chart(ctx, {
                            type: 'bar',
                            data: {
                                labels: labels,
                                datasets: [{
                                    data: data,
                                    backgroundColor: bgColors,
                                    borderColor: bgColors,
                                    borderWidth: 1,
                                    borderRadius: 4
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: { display: false },
                                    tooltip: { 
                                        callbacks: {
                                            label: function(context) { return context.raw.toFixed(2); }
                                        }
                                    }
                                },
                                scales: {
                                    y: { 
                                        beginAtZero: true, 
                                        grid: { color: '#374151' }, 
                                        ticks: { color: '#9CA3AF', font: {size: 10} } 
                                    },
                                    x: { 
                                        grid: { display: false }, 
                                        ticks: { color: '#D1D5DB', font: {size: 10} } 
                                    }
                                }
                            }
                        });
                        this.chartInstances.push(newChart);
                    });
                }
            }
        }
    </script>
</body>
</html>